

-- ============================================
-- POL칈TICAS RLS SEGURAS - VERSI칍N CORREGIDA (RE-EJECUTABLE)
-- ============================================

-- 1. LIMPIEZA TOTAL (Eliminar cualquier versi칩n anterior de las pol칤ticas)
-- ============================================

-- Profiles
DROP POLICY IF EXISTS "profiles_select_own" ON public.profiles;
DROP POLICY IF EXISTS "profiles_update_own" ON public.profiles;
DROP POLICY IF EXISTS "profiles_insert_own" ON public.profiles;
DROP POLICY IF EXISTS "profiles_select_all_authenticated" ON public.profiles;
DROP POLICY IF EXISTS "profiles_select_authenticated" ON public.profiles; -- Agregado para corregir tu error
DROP POLICY IF EXISTS "profiles_update_own_safe" ON public.profiles;

-- Services
DROP POLICY IF EXISTS "services_select_active" ON public.services;
DROP POLICY IF EXISTS "services_select_all_authenticated" ON public.services;
DROP POLICY IF EXISTS "services_modify_authenticated" ON public.services;
DROP POLICY IF EXISTS "services_select_public" ON public.services;
DROP POLICY IF EXISTS "services_modify_system_only" ON public.services;

-- Appointments
DROP POLICY IF EXISTS "appointments_select_own" ON public.appointments;
DROP POLICY IF EXISTS "appointments_insert_own" ON public.appointments;
DROP POLICY IF EXISTS "appointments_update_own" ON public.appointments;
DROP POLICY IF EXISTS "appointments_select_all_authenticated" ON public.appointments;
DROP POLICY IF EXISTS "appointments_update_all_authenticated" ON public.appointments;
DROP POLICY IF EXISTS "appointments_delete_authenticated" ON public.appointments;
DROP POLICY IF EXISTS "appointments_select_all" ON public.appointments;
DROP POLICY IF EXISTS "appointments_insert_own_only" ON public.appointments;
DROP POLICY IF EXISTS "appointments_update_authenticated" ON public.appointments;
DROP POLICY IF EXISTS "appointments_update_secure" ON public.appointments;
DROP POLICY IF EXISTS "appointments_delete_admin_only" ON public.appointments;

-- ============================================
-- 2. PROFILES - PROTECCI칍N CONTRA ESCALADA DE PRIVILEGIOS
-- ============================================

-- Leer: Todos pueden ver su propio perfil + usuarios autenticados ven otros perfiles
CREATE POLICY "profiles_select_authenticated"
  ON public.profiles
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- Insertar: Solo el trigger puede crear perfiles
CREATE POLICY "profiles_insert_own"
  ON public.profiles
  FOR INSERT
  WITH CHECK (auth.uid() = id);

-- 游 SEGURIDAD CR칈TICA: Actualizar perfil SIN permitir cambio de rol
CREATE POLICY "profiles_update_own_safe"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (
    auth.uid() = id 
    AND role = (SELECT role FROM public.profiles WHERE id = auth.uid())
  );

-- ============================================
-- 3. SERVICES - Solo lectura para usuarios normales
-- ============================================

-- Todos pueden ver servicios activos
CREATE POLICY "services_select_public"
  ON public.services
  FOR SELECT
  USING (true);

-- Nadie puede modificar desde el cliente (solo SQL o Dashboard Admin futuro)
CREATE POLICY "services_modify_system_only"
  ON public.services
  FOR ALL
  USING (false)
  WITH CHECK (false);

-- ============================================
-- 4. APPOINTMENTS - Seguridad Blindada
-- ============================================

-- Funci칩n auxiliar para verificar admin (si no existe ya)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN (
    SELECT role = 'admin' 
    FROM public.profiles 
    WHERE id = auth.uid()
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Ver citas: Autenticados ven todo (el filtro visual se hace en frontend)
CREATE POLICY "appointments_select_all"
  ON public.appointments
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- Crear citas: Solo para uno mismo y en estado pendiente
CREATE POLICY "appointments_insert_own_only"
  ON public.appointments
  FOR INSERT
  WITH CHECK (
    auth.uid() = client_id 
    AND status = 'pending'
  );

-- Actualizar: Cliente cancela SU cita, Admin gestiona TODAS
CREATE POLICY "appointments_update_secure"
  ON public.appointments
  FOR UPDATE
  USING (
    (auth.uid() = client_id) -- Cliente edita la suya
    OR 
    public.is_admin() -- Admin edita cualquiera
  );

-- Eliminar: SOLO el Admin puede borrar registros f칤sicamente
CREATE POLICY "appointments_delete_admin_only"
  ON public.appointments
  FOR DELETE
  USING (public.is_admin());

-- ============================================
-- 5. VERIFICACI칍N FINAL
-- ============================================

SELECT tablename, policyname, cmd 
FROM pg_policies 
WHERE schemaname = 'public' 
ORDER BY tablename;


-- Activar el motor de seguridad (RLS) en las tablas
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.services ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.appointments ENABLE ROW LEVEL SECURITY;


-- ============================================
-- SOLUCI칍N STORAGE: CREAR BUCKET Y POL칈TICAS
-- ============================================

-- 1. Crear el bucket 'avatars' asegurando el ID exacto en min칰sculas
-- (Si ya existe con otro nombre, esto crear치 el correcto que busca tu c칩digo)
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO UPDATE SET public = true;

-- 2. Habilitar seguridad RLS en la tabla de objetos
ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- 3. Limpiar pol칤ticas antiguas para evitar conflictos
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated Upload" ON storage.objects;
DROP POLICY IF EXISTS "Owner Manage" ON storage.objects;

-- 4. CREAR POL칈TICAS DE ACCESO

-- A) Lectura P칰blica: Cualquiera puede ver las fotos (necesario para mostrar el avatar en la app)
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'avatars' );

-- B) Subida: Solo usuarios autenticados pueden subir archivos
CREATE POLICY "Authenticated Upload"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'avatars' 
  AND auth.role() = 'authenticated'
);

-- C) Gesti칩n: El usuario puede actualizar/borrar SUS propios archivos
CREATE POLICY "Owner Manage"
ON storage.objects FOR ALL
USING (
  bucket_id = 'avatars' 
  AND auth.uid() = owner
);


ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS avatar_url text;

-- 1. Verificar la tabla de perfiles (Revisar si avatar_url tiene datos)
SELECT 
  id, 
  full_name, 
  phone, 
  role, 
  avatar_url, 
  updated_at 
FROM public.profiles;

-- 2. Verificar que las citas est칠n leyendo la foto del perfil correctamente
SELECT 
  a.id AS cita_id,
  a.appointment_date,
  a.status,
  p.full_name AS nombre_cliente,
  p.avatar_url AS foto_cliente
FROM public.appointments a
JOIN public.profiles p ON a.client_id = p.id
ORDER BY a.appointment_date DESC;

SELECT 
  id, 
  full_name, 
  phone, 
  avatar_url, 
  updated_at 
FROM public.profiles 
ORDER BY updated_at DESC 
LIMIT 10;


ALTER TABLE public.appointments
ADD COLUMN guest_name TEXT,
ADD COLUMN guest_phone TEXT;

-- Crear un 칤ndice 칰nico en la fecha de la cita
-- Esto impide f칤sicamente que existan dos citas activas (pending/completed) a la misma hora
CREATE UNIQUE INDEX unique_active_appointment_date 
ON public.appointments (appointment_date) 
WHERE status != 'cancelled';



-- ============================================
-- 1. TABLA DE HORARIOS DE ATENCI칍N
-- ============================================
CREATE TABLE IF NOT EXISTS public.business_hours (
  id bigint generated by default as identity primary key,
  day_of_week int not null check (day_of_week between 0 and 6), -- 0=Domingo, 1=Lunes...
  open_time time not null default '09:00:00',
  close_time time not null default '18:00:00',
  is_closed boolean default false,
  unique(day_of_week)
);

-- Insertar horarios por defecto (si no existen)
INSERT INTO public.business_hours (day_of_week, open_time, close_time, is_closed)
VALUES 
  (1, '09:00', '18:00', false), -- Lunes
  (2, '09:00', '18:00', false),
  (3, '09:00', '18:00', false),
  (4, '09:00', '18:00', false),
  (5, '09:00', '18:00', false),
  (6, '09:00', '14:00', false), -- S치bado
  (0, '00:00', '00:00', true)   -- Domingo
ON CONFLICT (day_of_week) DO NOTHING;

-- ============================================
-- 2. SEGURIDAD (RLS) - NIVEL EXPERTO
-- ============================================

-- Habilitar RLS en horarios
ALTER TABLE public.business_hours ENABLE ROW LEVEL SECURITY;

-- Pol칤tica: Todo el mundo puede VER los horarios (para reservar)
CREATE POLICY "Public read business_hours" 
  ON public.business_hours FOR SELECT USING (true);

-- Pol칤tica: Solo el ADMIN puede MODIFICAR horarios
CREATE POLICY "Admin manage business_hours" 
  ON public.business_hours FOR ALL 
  USING (public.is_admin()) 
  WITH CHECK (public.is_admin());

-- ACTUALIZAR SERVICIOS: Permitir que el admin los edite
-- (Borramos la pol칤tica antigua restrictiva y creamos una nueva)
DROP POLICY IF EXISTS "services_modify_system_only" ON public.services;

CREATE POLICY "Admin manage services" 
  ON public.services FOR ALL 
  USING (public.is_admin()) 
  WITH CHECK (public.is_admin());
